apiVersion: batch/v1
kind: CronJob
metadata:
  name: add-todo-db-backup-cronjob
  namespace: project
spec:
  schedule: "0 4 * * *" # 04:00 AM
  jobTemplate:
    spec:
      template:
        spec:
          # Kubernetes Service Account is bind to this Google Service Account.
          # This allows the Pod running with postgres-backup-sa to act as postgres-backup-gsa
          # and thus eliminates need of using storing keys in sectres and mounting them
          # to the container which would be both cumbersome and not very secure.
          serviceAccountName: postgres-backup-sa
          containers:
            - name: todo-backend-backup-cron
              image: google/cloud-sdk:latest
              imagePullPolicy: IfNotPresent
              env:
                - name: PGHOST
                  value: postgres-svc
                - name: PGDATABASE
                  value: postgres
                - name: PGUSER
                  value: postgres
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: pg-password
                      key: POSTGRES_PASSWORD
              command:
                - /bin/sh
                - -c
                - |
                  # Install Postgres client. Note: the version must match the server version
                  # so we can't use package provided by debian.
                  apt-get update 
                  apt-get install -y postgresql-common
                  /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -y
                  DEBIAN_FRONTEND=noninteractive apt-get install -y postgresql-client-18

                  # Do the backup
                  BACKUP_FILE=todo-backup-$(date +"%Y-%m-%d--%H-%M").pgdump.gz
                  pg_dump | gsutil cp -J - gs://dwk-project-todo-db-backup/$BACKUP_FILE
          restartPolicy: OnFailure
